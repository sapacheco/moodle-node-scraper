const puppeteer=require("puppeteer"),fs=require("fs-extra"),sanitize=require("sanitize-filename"),path=require("path"),request=require("request").defaults({jar:!0}),progress=require("request-progress"),term=require("terminal-kit").terminal,cheerio=require("cheerio"),_options={"forzar-redescarga":!1,"login-url":"https://aulavirtual.fio.unam.edu.ar/login/index.php","curso-url":"https://aulavirtual.fio.unam.edu.ar/course/view.php?id=184","curso-url":"https://aulavirtual.fio.unam.edu.ar/course/view.php?id=322","curso-url":"https://aulavirtual.fio.unam.edu.ar/enrol/index.php?id=83",username:"pache_08",password:"cuadrichanchoA0."},__config={width:1280,height:300};(async()=>{console.info("\n» INICIANDO PROCESO\n");const e=await puppeteer.launch({headless:!0,args:[`--window-size=${__config.width},${__config.height}`]});process.on("unhandledRejection",(e,a)=>{console.error("\n  ✖ Se produjo un error: Rechazo de promesa no manejado.")});const a=await e.newPage();await a.setCacheEnabled(!0);try{console.info("  » Intentando conectarse con el aula virtual..."),await a.goto(_options["login-url"],{waitUntil:"networkidle2"}),term.brightGreen("  ✓ Conexión establecida.\n\n")}catch(a){console.error("  ✖ No fué posible conectarse con el aula virtual."),e.close()}var t;await async function e(){var i=await a.cookies();await a.type("#username",_options.username),await a.type("#password",_options.password),await a.waitFor(1e3),console.info("  » Iniciando sesión en la cuenta..."),await Promise.all([a.click("#loginbtn"),a.waitForNavigation({waitUntil:"networkidle2"})]),(t=await a.cookies())[0].value!==i[0].value?term.brightGreen("  ✓ Autenticación concedida.\n\n"):(term.brightYellow("  ⚠️ Se produjo un error en la autenticación, reintentando...\n\n"),await e())}(),console.info("  » Obteniendo lista de recursos disponibles para la descarga..."),await a.goto(_options["curso-url"],{waitUntil:"networkidle2"}),await a.addScriptTag({path:"jquery-3.2.1.min.js"});let i=await a.evaluate(()=>{var e=function*(){for(var e=2,a=0,t=!1;;)yield"hsl("+360*a/e+", 30%, 50%, 0.5)",a++,!0===t&&a++,a>=e&&(a=1,e*=2,t=!0)}();_BLACKLIST_TIPOS=["https://aulavirtual.fio.unam.edu.ar/theme/image.php/clean/forum/1551107122/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/clean/page/1551107122/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/clean/feedback/1551107122/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/clean/attendance/1551107122/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/clean/url/1551107122/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/clean/assign/1551107122/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/clean/quiz/1551107122/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/clean/core/1551954692/f/sourcecode-24","https://aulavirtual.fio.unam.edu.ar/theme/image.php/clean/lesson/1551954692/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/more/page/1551954692/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/more/url/1551954692/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/more/core/1551954692/f/sourcecode-24","https://aulavirtual.fio.unam.edu.ar/theme/image.php/more/data/1551954692/icon","https://aulavirtual.fio.unam.edu.ar/theme/image.php/clean/glossary/1551954692/icon"],_BLACKLIST_TIPOS=_BLACKLIST_TIPOS.map(e=>e.replace(/\/\d+(?=\/)/gi,""));var a=$(".page-header-headings").text(),t=(e.next().value,jQuery("body .instancename").closest("a").filter(function(e,a){var t=jQuery(a).find("img").attr("src").replace(/\/\d+(?=\/)/gi,"");return-1===_BLACKLIST_TIPOS.indexOf(t)&&jQuery(a).css({background:"#00ff1936","border-radius":"5px",padding:"5px 10px"}),-1===_BLACKLIST_TIPOS.indexOf(t)}).map(function(t,i){var n=jQuery(i).attr("href").replace(/(^\s+|\s+$)/gi,""),r=$(i).closest(".course-content ul li.section.main").css("border","2px dashed green").attr("aria-label").replace(/(^\s+|\s+$)/gi,""),o=$(i).text().replace(new RegExp($(i).find(".accesshide").text()+"$"),"").replace(/(^\s+|\s+$)/gi,""),l="",s=$(i).closest(".activity"),c=$(i).closest(".activity").next();do{s=(c=s).prev();var u=c.closest(".course-content ul li.section.main").attr("aria-label"),d=s.closest(".course-content ul li.section.main").attr("aria-label");if(s.hasClass("modtype_label")){l=s.text().replace(/(^\s+|\s+$)/gi,""),e.next().value;break}}while(u===d);return{fileLink:n,fileName:o,fileTitle:o,sectionName:r,subSectionName:l,courseName:a,originalFileName:"",contentType:"",fileSize:null,isMoodleFolder_id:n.split("id=").length>1&&-1!=n.indexOf("folder")?n.split("id=").slice(-1)[0]:null}}).toArray());return console.table(t),t});term.brightGreen("  ✓ Total de archivos a descargar: "+i.length+"\n\n"),(i=i.map(e=>Object.assign(e,{fileName:sanitize(e.fileName,{replacement:"-"}),fileTitle:sanitize(e.fileTitle,{replacement:"-"}),sectionName:sanitize(e.sectionName,{replacement:"-"}),subSectionName:sanitize(e.subSectionName,{replacement:"-"})}))).forEach(e=>fs.ensureDirSync(path.join("descargas",e.courseName+" - Aula Virtual",e.sectionName,e.subSectionName))),console.info("  » Guardando una vista previa del curso..."),await a._client.send("Emulation.clearDeviceMetricsOverride"),await a.screenshot({path:"./descargas/"+i[0].courseName+" - Aula Virtual/Contenido del curso.png",fullPage:!0}),await a.pdf({path:"./descargas/"+i[0].courseName+" - Aula Virtual/Contenido del curso.pdf",format:"A4",printBackground:!0}),term.brightGreen('  ✓ Guardada en "./descargas/'+i[0].courseName+' - Aula Virtual/Contenido del curso.png"\n\n'),console.info("  » Analizando tipos de archivos..."),await new Promise(function(e,a){!function a(n,r=!1){var o={url:i[n].fileLink,headers:{Cookie:t[0].name+"="+t[0].value},rejectUnauthorized:!1,method:r?"GET":"HEAD"};null!==i[n].isMoodleFolder_id&&(o.strictSSL=!1,o.qs={id:i[n].isMoodleFolder_id}),request(o,function(t,o){if(t)console.error(`  ✖ [${n+1}/${i.length}] ${i[n].fileTitle}  →  Error. Reitentando...`),a(n);else{if(o.headers["content-disposition"]){var l=o.headers["content-disposition"].match(/filename=\"([^"]*)\"/gi)[0].split(".");l.length>1&&(fileExtension=l.slice(-1).toString().slice(0,-1),i[n].fileName=i[n].fileName+"."+fileExtension,i[n].originalFileName=l[0].split('"').slice(-1).toString()+"."+fileExtension)}if(o.headers["content-length"]&&(i[n].fileSize=+o.headers["content-length"]),o.headers["content-type"])if(i[n].contentType=o.headers["content-type"],!1===r&&console.log(`\n    [${n+1}/${i.length}] ${i[n].sectionName}:\n\t    Nombre: "${i[n].fileTitle}"\n\t    Tipo: ${o.headers["content-type"]}`),-1!=o.headers["content-type"].indexOf("html"))if(""==o.body)console.log("\t    El link conduce a un archivo HTML: Obteniendo recurso real..."),a(n,!0);else{var s=(c=o.body,u=cheerio.load(c),d="",u(".resourcecontent").length>0?d=u(".resourcecontent").html().match(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/gi)[0]:u(".resourceworkaround").length>0?d=u(".resourceworkaround").html().match(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/gi)[0]:u(".singlebutton > form:nth-child(1)").length>0?d=u(".singlebutton > form:nth-child(1)").attr("action"):u(".urlworkaround").length>0&&(d=u(".urlworkaround").html().match(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/gi)[0]),null!==d&&""!==d||(term.brightYellow("\t    ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄\n"),term.brightYellow("\t    ⚠️ Atención: No se pudo obtener la dirección del recurso. Se\n"),term.brightYellow("\t    descargará una imagen con un símbolo  de 'error' en su lugar\n"),term.brightYellow("\t    ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀\n"),d="https://upload.wikimedia.org/wikipedia/commons/5/5f/Icon_Simple_Error.png"),d);i[n].fileLink=s,console.log(`\t    Recurso real: "...${s.slice(-50)}"`),console.log("\t    Obteniendo información del archivo..."),a(n)}else n+1<i.length?a(n+1):(term.brightGreen("\n  ✓ Archivos analizados.\n"),console.log("    Peso total de los recursos: "+(i.reduce((e,a)=>({fileSize:e.fileSize+a.fileSize})).fileSize/1e6).toFixed(2)+" MB.\n\n"),e())}var c,u,d})}(0)}),console.info("  » Descargando archivos:\n"),await new Promise(function(e,a){function n(a){a+1<i.length?r(a+1):(term.brightGreen("\n  ✓ Descargados todos los archivos. Podés encontrarlos en la carpeta:\n\n"),term.brightBlue.bold('    "./descargas/'+i[0].courseName+' - Aula Virtual"\n\n'),e())}function r(e){if(function(e){var a=path.join("descargas",i[e].courseName+" - Aula Virtual",i[e].sectionName,i[e].subSectionName,i[e].fileName);try{if(fs.accessSync(a,fs.constants.F_OK),+fs.statSync(a).size===i[e].fileSize)return!0}catch(e){return!1}}(e)&&!_options["forzar-redescarga"])term.bold(`    [${e+1}/${i.length}] ${i[e].fileTitle}: `).brightGreen("Ya descargado previamente.\n\n"),n(e);else{var a=term.progressBar({eta:!0,percent:!0,title:`    [${e+1}/${i.length}] ${i[e].fileTitle}`,barStyle:term.brightGreen}),r={url:i[e].fileLink,headers:{Cookie:t[0].name+"="+t[0].value},rejectUnauthorized:!1,method:"GET"};null!==i[e].isMoodleFolder_id&&(r.strictSSL=!1,r.qs={id:i[e].isMoodleFolder_id}),progress(request(r,function(t,r){t&&(a&&a.stop(),term.bold.brightRed(`    [${e+1}/${i.length}] ${i[e].fileTitle}: Error.\n\n`),n(e))}),{}).on("progress",function(e){a.update(e.percent)}).on("error",function(e){}).on("end",function(){a.update(1),a.stop(),console.log("\n"),n(e)}).pipe(fs.createWriteStream(path.join("descargas",i[e].courseName+" - Aula Virtual",i[e].sectionName,i[e].subSectionName,i[e].fileName)))}}r(0)}),console.info("\n» FINALIZANDO PROCESO\n"),await e.close()})();